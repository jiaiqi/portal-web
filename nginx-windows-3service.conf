# =====================================================
# Nest Admin Windows 三服务 Nginx 配置
# 
# 服务架构：
# - 门户前端 (Portal)     : D:\\deploy\\portal-web\\dist
# - 后台管理 (Admin)      : D:\\deploy\\admin-vue3\\dist  
# - 后端 API              : http://localhost:8080
#
# Nginx 监听 80 端口，统一对外提供服务
# =====================================================

worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # 日志配置
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  logs/access.log  main;
    error_log  logs/error.log;

    # 性能优化
    sendfile        on;
    keepalive_timeout  65;

    # Gzip 压缩
    gzip  on;
    gzip_types  text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # 限制请求体大小（支持大文件上传）
    client_max_body_size  50M;

    # =====================================================
    # 方式一：单域名 + 子路径（推荐）
    # 访问地址：
    #   - 门户：http://localhost/
    #   - 后台：http://localhost/admin/
    #   - API： http://localhost/api/
    # =====================================================
    server {
        listen       80;
        server_name  localhost;  # 修改为你的域名或IP

        # -------------------- 1. 门户前端 (Nuxt) --------------------
        # 访问: http://localhost/
        # Nuxt 支持两种部署方式：
        
        # 方式 A：SSR 模式（推荐，需要运行 node .output/server/index.mjs）
        # location / {
        #     proxy_pass http://localhost:3000;
        #     proxy_http_version 1.1;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_set_header X-Forwarded-Proto $scheme;
            
        #     # WebSocket 支持（热更新）
        #     proxy_set_header Upgrade $http_upgrade;
        #     proxy_set_header Connection "upgrade";
        # }
        
        # 方式 B：静态生成 SSG（npm run generate）
        location / {
            root   D:\\deploy\\portal-web\\.output\\public;  # Nuxt 静态生成目录
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;

            # 禁用 HTML 缓存，防止重定向被缓存
            location ~* \\.html$ {
                expires -1;
                add_header Cache-Control "no-cache, no-store, must-revalidate";
                add_header Pragma "no-cache";
            }

            # 缓存静态资源
            location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|_nuxt)$ {
                expires 30d;
                add_header Cache-Control "public, immutable";
            }
        }

        # -------------------- 2. 后台管理 --------------------
        # 访问: http://localhost/admin/
        # 注意：前端需要设置 base: '/admin/' 并重新构建
        location /admin/ {
            alias  D:\\deploy\\admin-vue3\\dist\\;
            index  index.html index.htm;
            try_files $uri $uri/ /admin/index.html;
            
            # 禁用缓存，防止重定向问题
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
        }
        
        # 处理 /admin 路径（不带斜杠）
        location = /admin {
            return 301 /admin/;
        }

        # -------------------- 3. 后端 API --------------------
        # 访问: http://localhost/api/
        location /api/ {
            proxy_pass  http://localhost:8080/;
            proxy_http_version 1.1;

            proxy_set_header  Host  $host;
            proxy_set_header  X-Real-IP  $remote_addr;
            proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
            proxy_set_header  X-Forwarded-Proto  $scheme;

            # 超时设置
            proxy_connect_timeout  60s;
            proxy_send_timeout  60s;
            proxy_read_timeout  60s;

            # WebSocket 支持（如需要）
            proxy_set_header  Upgrade  $http_upgrade;
            proxy_set_header  Connection  "upgrade";
        }

        # -------------------- 4. 上传文件访问 --------------------
        location /uploads/ {
            alias  D:\\deploy\\nest-admin\\uploads\\;  # 上传文件目录
            expires  7d;
            add_header Cache-Control "public";
        }

        # -------------------- 5. 公共文件访问 --------------------
        location /public/ {
            alias  D:\\deploy\\nest-admin\\server\\public\\;  # 公共文件目录
            expires  30d;
            add_header Cache-Control "public";
        }

        # 错误页面
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }

    # =====================================================
    # 方式二：多端口部署（开发/测试环境）
    # 门户: http://localhost:8081
    # 后台: http://localhost:8082
    # API:  http://localhost:8080 (直接访问)
    # =====================================================

    # 门户站点 - 端口 8081
    server {
        listen       8081;
        server_name  localhost;

        location / {
            root   D:\\deploy\\portal-web\\dist;
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;
        }

        # API 代理
        location /api/ {
            proxy_pass  http://localhost:8080/;
            proxy_set_header  Host  $host;
            proxy_set_header  X-Real-IP  $remote_addr;
        }

        # 上传文件
        location /uploads/ {
            alias  D:\\deploy\\nest-admin\\uploads\\;
        }
    }

    # 后台站点 - 端口 8082
    server {
        listen       8082;
        server_name  localhost;

        location / {
            root   D:\\deploy\\admin-vue3\\dist;
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;
        }

        # API 代理
        location /api/ {
            proxy_pass  http://localhost:8080/;
            proxy_set_header  Host  $host;
            proxy_set_header  X-Real-IP  $remote_addr;
        }

        # 上传文件
        location /uploads/ {
            alias  D:\\deploy\\nest-admin\\uploads\\;
        }
    }
}
