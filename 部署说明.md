# Nest Admin 部署文档

## 系统架构

- **前端**: Vue 3 + Vite + Element Plus
- **后端**: NestJS + TypeORM + MySQL + Redis
- **Web服务器**: Nginx
- **Node版本**: >= 18.x

## 环境要求

- Linux 服务器 (Ubuntu 20.04+ / CentOS 7+)
- Node.js 18.x+
- MySQL 8.0+
- Redis 6.0+
- Nginx 1.18+

---

## 一、服务器环境准备

### 1.1 安装 Node.js 18.x

```bash
# 使用 NodeSource 安装
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node -v  # v18.x.x
npm -v   # 9.x.x
```

### 1.2 安装 MySQL 8.0

```bash
sudo apt update
sudo apt install mysql-server

# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation

# 登录 MySQL 创建数据库
sudo mysql -u root -p

# 执行以下 SQL
CREATE DATABASE nest_admin DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'root'@'localhost' IDENTIFIED BY '12345678';
GRANT ALL PRIVILEGES ON nest_admin.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 1.3 安装 Redis

```bash
sudo apt update
sudo apt install redis-server

# 配置 Redis
sudo vim /etc/redis/redis.conf

# 修改以下配置
bind 127.0.0.1
port 6379
# 开发环境无密码，生产环境建议设置密码
# requirepass your_redis_password

# 启动 Redis
sudo systemctl restart redis-server
sudo systemctl enable redis-server

# 验证
redis-cli ping  # 应返回 PONG
```

### 1.4 安装 Nginx

```bash
sudo apt update
sudo apt install nginx

# 启动 Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 1.5 安装 PM2（进程管理）

```bash
sudo npm install -g pm2
```

---

## 二、项目部署

### 2.1 创建部署目录

```bash
sudo mkdir -p /var/www/nest-admin
cd /var/www/nest-admin

# 设置权限
sudo chown -R $USER:$USER /var/www/nest-admin
```

### 2.2 上传项目代码

```bash
# 方式1: 使用 git
git clone https://your-repo.git .

# 方式2: 使用 scp 本地上传
scp -r /local/path/nest-admin-master/* user@server:/var/www/nest-admin/
```

项目结构应为：
```
/var/www/nest-admin/
├── server/          # 后端代码
├── admin-vue3/      # 前端代码
├── upload/          # 上传文件目录
└── logs/            # 日志目录
```

---

## 三、后端部署

### 3.1 进入后端目录

```bash
cd /var/www/nest-admin/server
```

### 3.2 安装依赖

```bash
npm install
```

### 3.3 配置生产环境

```bash
vim src/config/prod.yml
```

修改以下配置：

```yaml
# 生产环境配置
app:
  prefix: '/api'
  port: 8080
  logger:
    dir: '/var/www/nest-admin/logs'
  file:
    isLocal: true
    location: '/var/www/nest-admin/upload'
    domain: 'https://your-domain.com'  # 修改为你的域名
    serveRoot: '/public'
    maxSize: 50

# 数据库配置
db:
  mysql:
    host: '127.0.0.1'           # MySQL 主机
    username: 'root'            # MySQL 用户名
    password: '12345678'        # MySQL 密码
    database: 'nest_admin'
    port: 3306
    charset: 'utf8mb4'
    logger: 'file'
    logging: false
    multipleStatements: true
    dropSchema: false
    synchronize: false  # 生产环境设为 false
    supportBigNumbers: true
    bigNumberStrings: true

# Redis 配置
redis:
  host: 'localhost'
  password: ''              # 开发环境无密码
  port: 6379
  db: 2
  keyPrefix: ''

# JWT 配置
jwt:
  secretkey: 'you_secretkey'
  expiresin: '24h'
  refreshExpiresIn: '7d'
```

### 3.4 初始化数据库

```bash
# 如果是首次部署，需要导入数据库
mysql -u root -p12345678 nest_admin < /var/www/nest-admin/server/db/nest_admin.sql
```

### 3.5 构建项目

```bash
npm run build
```

### 3.6 使用 PM2 启动服务

```bash
# 创建 PM2 配置文件
vim ecosystem.config.js
```

```javascript
module.exports = {
  apps: [
    {
      name: 'nest-admin-api',
      script: './dist/main.js',
      instances: 'max',  // 根据 CPU 核心数启动多个实例
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
      },
      log_file: '/var/www/nest-admin/logs/combined.log',
      out_file: '/var/www/nest-admin/logs/out.log',
      error_file: '/var/www/nest-admin/logs/error.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      max_memory_restart: '1G',
      restart_delay: 3000,
      max_restarts: 5,
      min_uptime: '10s',
    },
  ],
};
```

```bash
# 启动服务
pm2 start ecosystem.config.js

# 保存 PM2 配置
pm2 save
pm2 startup

# 查看状态
pm2 status
pm2 logs nest-admin-api
```

---

## 四、前端部署

### 4.1 进入前端目录

```bash
cd /var/www/nest-admin/admin-vue3
```

### 4.2 安装依赖

```bash
npm install
```

### 4.3 配置生产环境

```bash
vim .env.production
```

```
# 生产环境配置
VITE_APP_BASE_API = '/api'
VITE_APP_TITLE = 'Nest Admin'
```

### 4.4 修改请求配置（如需要）

```bash
vim src/utils/request.js
```

确保基础 URL 配置正确：
```javascript
const service = axios.create({
  baseURL: import.meta.env.VITE_APP_BASE_API || '/api',
  timeout: 30000,
});
```

### 4.5 构建项目

```bash
npm run build:prod
```

构建完成后，会生成 `dist` 目录。

---

## 五、Nginx 配置

### 5.1 创建 Nginx 配置文件

```bash
sudo vim /etc/nginx/sites-available/nest-admin
```

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 修改为你的域名
    
    # 日志配置
    access_log /var/log/nginx/nest-admin-access.log;
    error_log /var/log/nginx/nest-admin-error.log;

    # 前端静态资源
    location / {
        root /var/www/nest-admin/admin-vue3/dist;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
        
        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # API 代理
    location /api/ {
        proxy_pass http://localhost:8080/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 文件上传目录
    location /public/ {
        alias /var/www/nest-admin/upload/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript;
}
```

### 5.2 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/nest-admin /etc/nginx/sites-enabled/

# 检查配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 5.3 配置 HTTPS（推荐）

使用 Let's Encrypt 免费证书：

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d your-domain.com

# 自动续期测试
sudo certbot renew --dry-run
```

---

## 六、防火墙配置

```bash
# 开放 HTTP/HTTPS
sudo ufw allow 'Nginx Full'

# 开放 SSH（如果未开放）
sudo ufw allow OpenSSH

# 启用防火墙
sudo ufw enable

# 查看状态
sudo ufw status
```

---

## 七、部署验证

### 7.1 检查服务状态

```bash
# 检查 PM2 状态
pm2 status

# 检查 Nginx 状态
sudo systemctl status nginx

# 检查 MySQL 状态
sudo systemctl status mysql

# 检查 Redis 状态
sudo systemctl status redis-server
```

### 7.2 测试接口

```bash
# 测试后端接口
curl http://localhost:8080/api/captchaImage

# 测试前端访问
curl http://your-domain.com
```

---

## 八、常用维护命令

### 8.1 后端维护

```bash
cd /var/www/nest-admin/server

# 重启服务
pm2 restart nest-admin-api

# 查看日志
pm2 logs nest-admin-api
pm2 logs nest-admin-api --lines 100

# 停止服务
pm2 stop nest-admin-api

# 删除服务
pm2 delete nest-admin-api
```

### 8.2 前端更新

```bash
cd /var/www/nest-admin/admin-vue3

# 拉取最新代码
git pull

# 重新构建
npm run build:prod

# Nginx 会自动加载新的静态文件
```

### 8.3 数据库备份

```bash
# 创建备份脚本
vim /var/www/nest-admin/backup.sh
```

```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/www/nest-admin/backups"
DB_NAME="nest_admin"
DB_USER="root"
DB_PASS="12345678"

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/${DB_NAME}_${DATE}.sql

# 保留最近 7 天的备份
find $BACKUP_DIR -name "${DB_NAME}_*.sql" -mtime +7 -delete

echo "Backup completed: ${DB_NAME}_${DATE}.sql"
```

```bash
chmod +x /var/www/nest-admin/backup.sh

# 添加到定时任务（每天凌晨 2 点备份）
crontab -e
0 2 * * * /var/www/nest-admin/backup.sh >> /var/log/nest-admin-backup.log 2>&1
```

---

## 九、故障排查

### 9.1 后端无法启动

```bash
# 查看错误日志
cat /var/www/nest-admin/logs/error.log

# 检查端口占用
sudo lsof -i :8080

# 检查数据库连接
mysql -u root -p12345678 -h localhost nest_admin

# 检查 Redis 连接
redis-cli ping
```

### 9.2 前端无法访问

```bash
# 检查 Nginx 错误日志
sudo tail -f /var/log/nginx/nest-admin-error.log

# 检查文件权限
ls -la /var/www/nest-admin/admin-vue3/dist/

# 检查 Nginx 配置
sudo nginx -t
```

### 9.3 502 Bad Gateway

```bash
# 检查后端服务是否运行
pm2 status

# 检查端口监听
sudo netstat -tlnp | grep 8080

# 重启后端服务
pm2 restart nest-admin-api
```

---

## 十、安全建议

1. **修改默认密码**: 修改所有默认密码（数据库、Redis、JWT Secret）
2. **定期更新**: 定期更新系统和依赖包
3. **备份策略**: 定期备份数据库和重要文件
4. **访问控制**: 限制服务器 SSH 访问，使用密钥登录
5. **监控告警**: 配置服务器监控和告警
6. **日志审计**: 定期审查访问日志和操作日志

---

## 十一、一键部署脚本

创建自动化部署脚本：

```bash
vim /var/www/nest-admin/deploy.sh
```

```bash
#!/bin/bash

set -e

echo "========== Nest Admin 部署脚本 =========="

# 配置
PROJECT_DIR="/var/www/nest-admin"
DB_NAME="nest_admin"
DB_USER="root"
DB_PASS="12345678"
REDIS_PASS=""              # 开发环境无密码
JWT_SECRET="you_secretkey"
DOMAIN="your-domain.com"

# 颜色输出
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${GREEN}1. 安装系统依赖...${NC}"
apt update
apt install -y nginx mysql-server redis-server nodejs npm git

# 安装 Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs

# 安装 PM2
npm install -g pm2

echo -e "${GREEN}2. 配置 MySQL...${NC}"
mysql -e "CREATE DATABASE IF NOT EXISTS ${DB_NAME} DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
mysql -e "ALTER USER '${DB_USER}'@'localhost' IDENTIFIED WITH mysql_native_password BY '${DB_PASS}';" || true
mysql -e "GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost';"
mysql -e "FLUSH PRIVILEGES;"

echo -e "${GREEN}3. 配置 Redis...${NC}"
# 开发环境无密码，如需设置密码取消下面注释
# sed -i "s/# requirepass foobared/requirepass ${REDIS_PASS}/" /etc/redis/redis.conf
systemctl restart redis-server

echo -e "${GREEN}4. 创建项目目录...${NC}"
mkdir -p ${PROJECT_DIR}/upload
mkdir -p ${PROJECT_DIR}/logs
mkdir -p ${PROJECT_DIR}/backups

echo -e "${GREEN}5. 部署后端...${NC}"
cd ${PROJECT_DIR}/server

# 安装依赖
npm install

# 修改配置文件
sed -i "s/127.0.0.1/localhost/g" src/config/prod.yml || true
sed -i "s/username: 'root'/username: '${DB_USER}'/g" src/config/prod.yml || true
sed -i "s/password: '12345678'/password: '${DB_PASS}'/g" src/config/prod.yml || true
sed -i "s/your-domain.com/${DOMAIN}/g" src/config/prod.yml || true

# 构建
npm run build

# 导入数据库
mysql -u${DB_USER} -p${DB_PASS} ${DB_NAME} < ${PROJECT_DIR}/server/db/nest_admin.sql || true

# 启动服务
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'nest-admin-api',
    script: './dist/main.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: { NODE_ENV: 'production' },
    log_file: '${PROJECT_DIR}/logs/combined.log',
    out_file: '${PROJECT_DIR}/logs/out.log',
    error_file: '${PROJECT_DIR}/logs/error.log',
    max_memory_restart: '1G',
  }],
};
EOF

pm2 start ecosystem.config.js
pm2 save
pm2 startup

echo -e "${GREEN}6. 部署前端...${NC}"
cd ${PROJECT_DIR}/admin-vue3

# 安装依赖
npm install

# 构建
npm run build:prod

echo -e "${GREEN}7. 配置 Nginx...${NC}"
cat > /etc/nginx/sites-available/nest-admin << EOF
server {
    listen 80;
    server_name ${DOMAIN};
    
    access_log /var/log/nginx/nest-admin-access.log;
    error_log /var/log/nginx/nest-admin-error.log;

    location / {
        root ${PROJECT_DIR}/admin-vue3/dist;
        index index.html;
        try_files \$uri \$uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://localhost:8080/;
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }

    location /public/ {
        alias ${PROJECT_DIR}/upload/;
        expires 30d;
    }
}
EOF

ln -sf /etc/nginx/sites-available/nest-admin /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default

nginx -t
systemctl restart nginx

echo -e "${GREEN}8. 配置防火墙...${NC}"
ufw allow 'Nginx Full'
ufw allow OpenSSH
ufw --force enable

echo -e "${GREEN}========== 部署完成 ==========${NC}"
echo "访问地址: http://${DOMAIN}"
echo "默认账号: admin / 123456"
echo ""
echo "查看日志: pm2 logs nest-admin-api"
echo "重启服务: pm2 restart nest-admin-api"
```

```bash
chmod +x /var/www/nest-admin/deploy.sh

# 运行部署脚本
sudo /var/www/nest-admin/deploy.sh
```

---

## 十二、联系方式

如有问题，请查看项目文档或提交 Issue。
